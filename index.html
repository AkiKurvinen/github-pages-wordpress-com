<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WP Blog</title>
    <link rel="shortcut icon" href="favicon.png" type="image/x-icon">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="skeleton-screen-css/index.min.css" />
</head>

<body>
    <div id="root">
        <!-- React components will be rendered here -->
    </div>

    <script type="text/babel">
        // Babel standalone in the browser does not support ES module imports (import/export) or require

        // UTILITY 
        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html || '';
            return tmp.textContent?.trim() || '';
        }

        // COMPONENTS
        function Nav({ tag, meta, allTags = [], setTag, activelink }) {
            return (
                <nav className="navbar">
                    <a href="./" className="logo" onClick={() => setTag(null)}>{meta.name}</a>
                    <ul className="nav-list">
                        <li className={activelink == "all" ? "nav-link-active" : ""}>
                            <a className="nav-link" href="#hobbies" onClick={() => setTag(null)}>All</a>
                        </li>
                        {allTags && allTags.map((tg) =>
                            <li key={tg} className={activelink == tg ? "nav-link-active" : ""}><a className="nav-link" href="#hobbies" onClick={() => setTag(tg)}>{tg}</a></li>
                        )}
                        <li><a className="nav-link" href="#about">About</a></li>
                    </ul>
                </nav>

            );
        }

        function Header({ meta, header, tag, allTags, setTag, activelink }) {
            return (
                <>
                    <header className="site-header">
                        <Nav tag={tag} meta={meta} allTags={allTags} setTag={setTag} activelink={activelink} />
                    </header>
                    <div className="hero">
                        <p className="herotext" >{header.title}</p>
                        <p className="herodesc" dangerouslySetInnerHTML={{ __html: header.content }}></p>
                    </div>
                </>
            )
        }

        function Footer({ footer }) {
            return (
                <footer className="site-footer" id="about"
                    dangerouslySetInnerHTML={{ __html: footer.content }}>
                </footer>)
        }

        function Card({ post }) {
            const [showFull, setShowFull] = React.useState(false);
            const headerImg = post.featured_image || (post.attachments && Object.values(post.attachments)[0]?.URL) || post.thumbnail || null;
            // Detect if excerpt and content are the same (ignoring HTML)
            const excerptText = stripHtml(post.excerpt);
            const contentText = stripHtml(post.content);
            const fitsExcerpt = excerptText === contentText;
            return (
                <div className="card">
                    <div className="card-title">{post.title}</div>
                    <div className="card-content">
                        {headerImg && (
                            <img className="card-image" src={headerImg} alt="Post header" />
                        )}
                        {!showFull ? (
                            <>
                                <p className="card-excerpt" dangerouslySetInnerHTML={{ __html: post.excerpt }}></p>
                                {!fitsExcerpt && (
                                    <button className="card-btn" onClick={() => setShowFull(true)}>Read more</button>
                                )}
                            </>
                        ) : (
                            <div>
                                <div className="card-full-content" dangerouslySetInnerHTML={{ __html: post.content }}></div>
                                <button className="card-btn card-btn-less" onClick={() => setShowFull(false)}>Show less</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function CardsList({ posts }) {
            return (
                <div className="cards-list">
                    {posts.map(post => <Card key={post.ID} post={post} />)}
                </div>
            );
        }

        // SKELETONS
        function HeaderSkeleton() {
            return (
                <>
                    <div className="ssc-square" style={{ height: '50px' }}></div>
                    <div className="ssc-square hero" style={{ height: '230px' }}></div>
                </>
            );
        }

        function CardSkeleton() {
            return (
                <div className="ssc-card card card-skeleton"></div>
            );
        }

        function CardsListSkeleton() {
            return (
                <div className="cards-list">
                    <CardSkeleton />
                    <CardSkeleton />
                    <CardSkeleton />
                </div>
            );
        }

        const WPSITENAME = "hobbierecs"
        const WPSITENUMBER = "246259228"
        const TESTMODE = false

        // CONTROLLERS
        async function fetchWPContent() {
            let site_url = `https://public-api.wordpress.com/rest/v1/sites/${WPSITENAME}.wordpress.com/`
            let posts_url = `https://public-api.wordpress.com/rest/v1.1/sites/${WPSITENUMBER}/posts/`
            if (TESTMODE) {
                function delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                }
                await delay(2000);
                site_url = 'json/meta.json'
                posts_url = 'json/posts.json'
            }
            return Promise.all([
                fetch(site_url).then(r => r.json()),
                fetch(posts_url).then(r => r.json())
            ]).then(([meta, posts]) => ({ meta, posts }));
        }
        function App({ meta, posts }) {
            const [activelink, setActivelink] = React.useState('all');
            const [tag, setTag] = React.useState(null);
            const [allTags, setallTags] = React.useState(null);

            function handgeTagChange(tg) {
                setTag(tg);
                setActivelink(tg || 'all');
            }

            function findUniqueTags(items) {
                const tagsSet = new Set();
                items.forEach(post => {
                    if (post.tags && typeof post.tags === 'object') {
                        Object.values(post.tags).forEach(tagObj => {
                            if (tagObj && tagObj.name) tagsSet.add(tagObj.name);
                        });
                    }
                });
                return Array.from(tagsSet).sort();
            }

            let items = posts.posts.filter(post => post.categories && Object.keys(post.categories).includes("postitem"));

            if (tag) {
                items = items.filter(post => post.tags && Object.values(post.tags).some(tagObj => tagObj.name === tag));
            }

            let header = posts.posts.filter(post => post.categories && Object.keys(post.categories).includes("header"))[0];
            let footer = posts.posts.filter(post => post.categories && Object.keys(post.categories).includes("footer"))[0];
            document.title = meta.name;

            if (!allTags) setallTags(findUniqueTags(posts.posts));
            if (meta.icon) {
                let favicon = document.querySelector('link[rel~="icon"]');
                if (!favicon) {
                    favicon = document.createElement('link');
                    favicon.rel = 'icon';
                    document.head.appendChild(favicon);
                }
                favicon.href = meta.icon.img;
            }
            return (
                <div className="app">
                    <Header meta={meta} header={header} allTags={allTags} tag={tag} setTag={handgeTagChange} activelink={activelink} setActivelink={setActivelink} />
                    <div id="container">
                        <h1 id="hobbies">Hobbies {tag && ` / ${tag}`}</h1>
                        <CardsList posts={items} />
                    </div>
                    <Footer footer={footer} />
                </div>
            );
        }

        async function main() {
            const domNode = document.getElementById('root');
            const root = ReactDOM.createRoot(domNode);

            root.render(
                <>
                    <HeaderSkeleton />
                    <div id="container">
                        <CardsListSkeleton />
                    </div>
                </>
            );

            try {
                const { meta, posts } = await fetchWPContent();
                root.render(
                    <App meta={meta} posts={posts} />
                );
            } catch (error) {
                console.error("Failed to load posts:", error);
                root.render(<div style={{ color: 'red' }}>Failed to load posts.</div>);
            }
        }
        main();
    </script>
</body>

</html>